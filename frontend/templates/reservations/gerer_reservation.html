{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Je gère ma réservation - AGCF Voyages{% endblock %}

{% block content %}
<div class="hero-section" style="padding: 3rem 0;">
    <div class="container text-center">
        <h1 class="display-6 mb-2"><i class="bi bi-clock-history"></i> Je gère ma réservation</h1>
        <p class="lead mb-0">Consultez, annulez ou modifiez votre billet facilement grâce à votre code de réservation.</p>
    </div>
</div>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h4 class="mb-3 d-flex align-items-center gap-2">
                        <span class="badge bg-primary rounded-pill"><i class="bi bi-1-circle"></i></span>
                        Retrouver votre billet
                    </h4>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="rechercher">
                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ gestion_form.code_reservation|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ gestion_form.email|as_crispy_field }}
                            </div>
                            <div class="col-12 text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Rechercher ma réservation
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if reservation %}
    <div class="row justify-content-center mt-4">
        <div class="col-lg-10">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h4 class="mb-3 d-flex align-items-center gap-2">
                        <span class="badge bg-success rounded-pill"><i class="bi bi-2-circle"></i></span>
                        Détails de la réservation
                    </h4>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100">
                                <p class="text-muted mb-1">Code de réservation</p>
                                <p class="fs-4 fw-bold">{{ reservation.code_reservation }}</p>
                                <p class="text-muted mb-1">Voyageur</p>
                                <p class="fw-semibold">{{ reservation.utilisateur.get_full_name|default:reservation.utilisateur.username }}</p>
                                <p class="text-muted mb-1">Statut</p>
                                <span class="badge {% if reservation.statut == 'confirmee' %}bg-success{% elif reservation.statut == 'annulee' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                    {{ reservation.get_statut_display }}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100">
                                <p class="text-muted mb-1">Trajet</p>
                                <p class="fw-semibold">{{ reservation.train.gare_depart.ville }} → {{ reservation.train.gare_arrivee.ville }}</p>
                                <p class="text-muted mb-1">Date de voyage</p>
                                <p class="fw-semibold">{{ reservation.date_voyage|date:"d/m/Y" }}</p>
                                <p class="text-muted mb-1">Horaire</p>
                                <p class="fw-semibold">{{ reservation.train.heure_depart|time:"H:i" }} - {{ reservation.train.heure_arrivee|time:"H:i" }}</p>
                                <p class="text-muted mb-1 mt-2">Train</p>
                                <p class="fw-semibold">{{ reservation.train.numero }}</p>
                                <p class="text-muted mb-1 mt-2">Durée</p>
                                <p class="fw-semibold">{{ reservation.train.duree_formatee }}</p>
                            </div>
                        </div>
                    </div>

                    {% if reservation.statut == 'confirmee' %}
                    <div class="row mt-3 mb-3">
                        <div class="col-12">
                            <div class="alert {% if billet_modifie or request.session.telecharger_billet_modifie == reservation.code_reservation %}alert-success{% else %}alert-info{% endif %} d-flex align-items-center justify-content-between flex-wrap">
                                <div class="mb-2 mb-md-0">
                                    {% if billet_modifie or request.session.telecharger_billet_modifie == reservation.code_reservation %}
                                    <i class="bi bi-check-circle-fill me-2"></i>
                                    <div>
                                        <strong>Billet modifié avec succès !</strong><br>
                                        <small>Votre nouveau billet avec les modifications est disponible au téléchargement ci-dessous et a été envoyé à <strong>{{ reservation.utilisateur.email }}</strong>.</small>
                                    </div>
                                    {% else %}
                                    <i class="bi bi-file-earmark-pdf me-2"></i>
                                    <strong>Billet disponible</strong> - Téléchargez votre billet PDF ou consultez-le dans votre email.
                                    {% endif %}
                                </div>
                                {% if email_recherche %}
                                <a href="{% url 'reservations:telecharger_billet_public' reservation.code_reservation %}?email={{ email_recherche|urlencode }}" 
                                   class="btn {% if request.session.telecharger_billet_modifie and request.session.telecharger_billet_modifie == reservation.code_reservation %}btn-success{% else %}btn-primary{% endif %} btn-sm" 
                                   id="download-billet-link">
                                    <i class="bi bi-download"></i> Télécharger le billet
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="row g-4 mt-1">
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100">
                                <h5 class="fw-bold mb-3"><i class="bi bi-slash-circle"></i> Annuler mon billet</h5>
                                <p class="text-muted">Annulez votre voyage et libérez les places réservées. Selon les conditions, des frais peuvent s'appliquer.</p>
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="annuler">
                                    {% if annulation_form %}
                                        {{ annulation_form.reservation_id }}
                                        {{ annulation_form.code_reservation }}
                                        {{ annulation_form.email }}
                                    {% endif %}
                                    <button type="submit" class="btn btn-outline-danger w-100" {% if reservation.statut == 'annulee' %}disabled{% endif %}>
                                        <i class="bi bi-x-circle"></i> Annuler cette réservation
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100">
                                <h5 class="fw-bold mb-3"><i class="bi bi-arrow-repeat"></i> Changer d'horaire</h5>
                                <p class="text-muted">Choisissez un nouvel horaire sur le même trajet et mettez à jour votre billet instantanément. Le nouveau billet sera envoyé par email et disponible au téléchargement.</p>
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="modifier">
                                    {% if reschedule_form %}
                                        {{ reschedule_form.reservation_id }}
                                        {{ reschedule_form.code_reservation }}
                                        {{ reschedule_form.email }}
                                        <div class="mb-3">
                                            {{ reschedule_form.nouvelle_date|as_crispy_field }}
                                        </div>
                                        <div class="mb-3">
                                            {{ reschedule_form.nouveau_train|as_crispy_field }}
                                        </div>
                                        <button type="submit" class="btn btn-outline-primary w-100" {% if reservation.statut == 'annulee' %}disabled{% endif %}>
                                            <i class="bi bi-calendar2-plus"></i> Valider le changement
                                        </button>
                                    {% else %}
                                        <p class="text-muted">Commencez par rechercher votre réservation pour accéder à cette option.</p>
                                    {% endif %}
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    {# Afficher le nouveau billet après modification #}
                    {% if billet_modifie or show_new_ticket %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card border-success shadow-sm">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-check-circle-fill me-2"></i>Nouveau billet modifié avec succès
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-warning mb-3">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Important:</strong> Votre ancien billet a été annulé automatiquement. Voici votre nouveau billet avec les modifications.
                                    </div>
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <p class="text-muted mb-1 small">Code de réservation</p>
                                            <p class="fw-bold fs-5 mb-3">{{ reservation.code_reservation }}</p>
                                            <p class="text-muted mb-1 small">Date de voyage</p>
                                            <p class="fw-semibold mb-3">{{ reservation.date_voyage|date:"d/m/Y" }}</p>
                                            <p class="text-muted mb-1 small">Train</p>
                                            <p class="fw-semibold mb-0">{{ reservation.train.numero }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="text-muted mb-1 small">Trajet</p>
                                            <p class="fw-semibold mb-3">{{ reservation.train.gare_depart.ville }} → {{ reservation.train.gare_arrivee.ville }}</p>
                                            <p class="text-muted mb-1 small">Horaire</p>
                                            <p class="fw-semibold mb-3">{{ reservation.train.heure_depart|time:"H:i" }} - {{ reservation.train.heure_arrivee|time:"H:i" }}</p>
                                            <p class="text-muted mb-1 small">Durée</p>
                                            <p class="fw-semibold mb-0">{{ reservation.train.duree_formatee }}</p>
                                        </div>
                                    </div>
                                    <div class="mt-4 pt-3 border-top">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                                            <div class="mb-2 mb-md-0">
                                                <small class="text-muted d-block">Billet envoyé à</small>
                                                <strong class="text-success">{{ reservation.utilisateur.email }}</strong>
                                            </div>
                                            {% if email_recherche %}
                                            <a href="{% url 'reservations:telecharger_billet_public' reservation.code_reservation %}?email={{ email_recherche|urlencode }}" 
                                               class="btn btn-success btn-lg">
                                                <i class="bi bi-download"></i> Télécharger le billet PDF
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% elif request.session.telecharger_billet_modifie %}
                    {# Fallback: Afficher aussi si le flag de session existe #}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card border-success shadow-sm">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-check-circle-fill me-2"></i>Nouveau billet modifié avec succès
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info mb-3">
                                        <small><strong>Note:</strong> Votre ancien billet a été annulé automatiquement. Voici votre nouveau billet.</small>
                                    </div>
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <p class="text-muted mb-1 small">Code de réservation</p>
                                            <p class="fw-bold fs-5 mb-3">{{ reservation.code_reservation }}</p>
                                            <p class="text-muted mb-1 small">Date de voyage</p>
                                            <p class="fw-semibold mb-3">{{ reservation.date_voyage|date:"d/m/Y" }}</p>
                                            <p class="text-muted mb-1 small">Train</p>
                                            <p class="fw-semibold mb-0">{{ reservation.train.numero }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="text-muted mb-1 small">Trajet</p>
                                            <p class="fw-semibold mb-3">{{ reservation.train.gare_depart.ville }} → {{ reservation.train.gare_arrivee.ville }}</p>
                                            <p class="text-muted mb-1 small">Horaire</p>
                                            <p class="fw-semibold mb-3">{{ reservation.train.heure_depart|time:"H:i" }} - {{ reservation.train.heure_arrivee|time:"H:i" }}</p>
                                            <p class="text-muted mb-1 small">Durée</p>
                                            <p class="fw-semibold mb-0">{{ reservation.train.duree_formatee }}</p>
                                        </div>
                                    </div>
                                    <div class="mt-4 pt-3 border-top">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                                            <div class="mb-2 mb-md-0">
                                                <small class="text-muted d-block">Billet envoyé à</small>
                                                <strong class="text-success">{{ reservation.utilisateur.email }}</strong>
                                            </div>
                                            {% if email_recherche %}
                                            <a href="{% url 'reservations:telecharger_billet_public' reservation.code_reservation %}?email={{ email_recherche|urlencode }}" 
                                               class="btn btn-success btn-lg">
                                                <i class="bi bi-download"></i> Télécharger le billet PDF
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if reservation and reservation.statut == 'confirmee' %}
<script>
// Télécharger automatiquement le billet si la session le demande (après modification)
{% if request.session.telecharger_billet_modifie == reservation.code_reservation and email_recherche %}
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const downloadLink = document.getElementById('download-billet-link');
        if (downloadLink) {
            // Nettoyer la session après le téléchargement
            fetch('{% url "reservations:gerer_reservation" %}?clear_download=1', {
                method: 'GET'
            }).then(function() {
                // Déclencher le téléchargement
                window.location.href = downloadLink.href;
            });
        }
    }, 1500);
});
{% endif %}
</script>
{% endif %}
{% endblock %}

