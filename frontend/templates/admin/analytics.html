{% extends "admin/base.html" %}
{% load static %}

{% block title %}Analyse des revenus et passagers | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .analytics-container {
        padding: 20px;
        background: #f8f9fa;
    }
    .stats-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stats-card h3 {
        margin-top: 0;
        color: #000000 !important;
    }
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #000000 !important;
        margin: 10px 0;
    }
    .stat-label {
        color: #000000 !important;
        font-size: 0.9rem;
    }
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .chart-container canvas {
        max-height: 400px !important;
        height: 400px !important;
    }
    .filters {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 1px solid #dee2e6;
    }
    .filters form {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
        min-width: 200px;
        position: relative;
    }
    .filters label {
        font-weight: 600;
        font-size: 0.95rem;
        color: #000000 !important;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }
    .filters select {
        padding: 12px 15px;
        border: 2px solid #667eea;
        border-radius: 8px;
        background: #ffffff !important;
        background-color: #ffffff !important;
        color: #000000 !important;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23000000' d='M6 9L1 4h10z'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: right 15px center !important;
        padding-right: 40px;
    }
    .filters select:hover {
        border-color: #764ba2;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        background: #ffffff !important;
        background-color: #ffffff !important;
        color: #000000 !important;
    }
    .filters select:focus {
        outline: none;
        border-color: #764ba2;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: #ffffff !important;
        background-color: #ffffff !important;
        color: #000000 !important;
    }
    .filters select option {
        background: #ffffff !important;
        background-color: #ffffff !important;
        color: #000000 !important;
        padding: 10px;
    }
    .filters select option:checked {
        background: #f0f0f0 !important;
        background-color: #f0f0f0 !important;
        color: #000000 !important;
    }
    .filters select option:hover {
        background: #e9ecef !important;
        background-color: #e9ecef !important;
    }
    .filters button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        cursor: pointer;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        align-self: flex-end;
        margin-top: 24px;
    }
    .filters button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .filters button:active {
        transform: translateY(0);
    }
    .ai-insight {
        background: #ffffff !important;
        color: #000000 !important;
        border: 2px solid #667eea;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .ai-insight h3 {
        color: #000000 !important;
        margin-top: 0;
    }
    .ai-insight p,
    .ai-insight li,
    .ai-insight strong {
        color: #000000 !important;
    }
    .trend-up {
        color: #28a745;
    }
    .trend-down {
        color: #dc3545;
    }
    .prediction-box {
        background: #f8f9fa !important;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        color: #000000 !important;
    }
    .prediction-box p,
    .prediction-box li,
    .prediction-box strong {
        color: #000000 !important;
    }
    .chart-container h3 {
        color: #000000 !important;
    }
    .analytics-container h1 {
        color: #000000 !important;
    }
    .analytics-container {
        color: #000000 !important;
    }
    .analytics-container * {
        color: #000000 !important;
    }
    .analytics-container .trend-up {
        color: #28a745 !important;
    }
    .analytics-container .trend-down {
        color: #dc3545 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h1 style="margin-bottom: 30px; color: #000000 !important;">
        <i class="bi bi-graph-up-arrow"></i> Analyse des revenus et volume de passagers
    </h1>

    <!-- Filtres -->
    <div class="filters">
        <form method="get" action="{% url 'admin_analytics' %}">
            <div class="filter-group">
                <label for="period">
                    <i class="bi bi-calendar-range"></i> P√©riode
                </label>
                <div style="position: relative !important; display: inline-block; width: 100%;">
                    <span id="period-icon" style="position: absolute !important; left: 15px !important; top: 50% !important; transform: translateY(-50%) !important; pointer-events: none !important; font-size: 1.3rem !important; z-index: 1000 !important; line-height: 1 !important; display: block !important; visibility: visible !important; opacity: 1 !important; color: #000000 !important;">üìÖ</span>
                    <select name="period" id="period" style="width: 100%; background: #ffffff !important; background-color: #ffffff !important; color: #000000 !important; padding-left: 50px !important; padding-right: 40px !important; position: relative; z-index: 1;">
                        <option value="7" {% if period == '7' %}selected{% endif %} style="background: #ffffff !important; color: #000000 !important;">7 derniers jours</option>
                        <option value="30" {% if period == '30' %}selected{% endif %} style="background: #ffffff !important; color: #000000 !important;">30 derniers jours</option>
                        <option value="90" {% if period == '90' %}selected{% endif %} style="background: #ffffff !important; color: #000000 !important;">90 derniers jours</option>
                        <option value="365" {% if period == '365' %}selected{% endif %} style="background: #ffffff !important; color: #000000 !important;">1 an</option>
                        <option value="all" {% if period == 'all' %}selected{% endif %} style="background: #ffffff !important; color: #000000 !important;">Toutes les donn√©es</option>
                    </select>
                </div>
            </div>

            <div class="filter-group">
                <label for="chart_type">
                    <i class="bi bi-bar-chart"></i> Vue
                </label>
                <div style="position: relative !important; display: inline-block; width: 100%;">
                    <span id="chart_type-icon" style="position: absolute !important; left: 15px !important; top: 50% !important; transform: translateY(-50%) !important; pointer-events: none !important; font-size: 1.3rem !important; z-index: 1000 !important; line-height: 1 !important; display: block !important; visibility: visible !important; opacity: 1 !important; color: #000000 !important;">üìä</span>
                    <select name="chart_type" id="chart_type" style="width: 100%; background: #ffffff !important; background-color: #ffffff !important; color: #000000 !important; padding-left: 50px !important; padding-right: 40px !important; position: relative; z-index: 1;">
                        <option value="daily" {% if chart_type == 'daily' %}selected{% endif %} style="background: #ffffff !important; color: #000000 !important;">Par jour</option>
                        <option value="weekly" {% if chart_type == 'weekly' %}selected{% endif %} style="background: #ffffff !important; color: #000000 !important;">Par semaine</option>
                        <option value="monthly" {% if chart_type == 'monthly' %}selected{% endif %} style="background: #ffffff !important; color: #000000 !important;">Par mois</option>
                    </select>
                </div>
            </div>

            <button type="submit">
                <i class="bi bi-arrow-clockwise"></i> Actualiser
            </button>
        </form>
    </div>

    <!-- Statistiques globales -->
    <div class="row" style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div class="stats-card" style="flex: 1;">
            <h3 style="color: #000000 !important;"><i class="bi bi-cash-stack"></i> Revenus totaux</h3>
            <div class="stat-value" style="color: #000000 !important;">{{ total_revenue|floatformat:2 }} MAD</div>
            <div class="stat-label" style="color: #000000 !important;">
                {% if start_date %}
                    Du {{ start_date|date:"d/m/Y" }} au {{ end_date|date:"d/m/Y" }}
                {% else %}
                    Toutes les r√©servations
                {% endif %}
            </div>
        </div>

        <div class="stats-card" style="flex: 1;">
            <h3 style="color: #000000 !important;"><i class="bi bi-people"></i> Total passagers</h3>
            <div class="stat-value" style="color: #000000 !important;">{{ total_passengers }}</div>
            <div class="stat-label" style="color: #000000 !important;">{{ total_reservations }} r√©servations</div>
        </div>

        <div class="stats-card" style="flex: 1;">
            <h3 style="color: #000000 !important;"><i class="bi bi-calculator"></i> Revenu moyen/jour</h3>
            <div class="stat-value" style="color: #000000 !important;">{{ avg_daily_revenue|floatformat:2 }} MAD</div>
            <div class="stat-label" style="color: #000000 !important;">Moyenne quotidienne</div>
        </div>

        <div class="stats-card" style="flex: 1;">
            <h3 style="color: #000000 !important;"><i class="bi bi-person-check"></i> Passagers/r√©servation</h3>
            <div class="stat-value" style="color: #000000 !important;">{{ avg_passengers_per_reservation|floatformat:1 }}</div>
            <div class="stat-label" style="color: #000000 !important;">Moyenne par r√©servation</div>
        </div>
    </div>

    <!-- Insights IA -->
    <div class="ai-insight">
        <h3 style="color: #000000 !important;"><i class="bi bi-robot"></i> Analyse pr√©dictive IA</h3>
        <div class="prediction-box">
            <p style="color: #000000 !important;"><strong style="color: #000000 !important;">Pr√©diction pour les 7 prochains jours :</strong></p>
            <ul style="list-style: none; padding: 0;">
                <li style="margin: 10px 0; color: #000000 !important;">
                    <i class="bi bi-cash-coin"></i> Revenus estim√©s : <strong style="color: #000000 !important;">{{ predicted_revenue|floatformat:2 }} MAD</strong>
                </li>
                <li style="margin: 10px 0; color: #000000 !important;">
                    <i class="bi bi-people-fill"></i> Passagers estim√©s : <strong style="color: #000000 !important;">{{ predicted_passengers }}</strong>
                </li>
            </ul>
            {% if trend_percentage != 0 %}
            <p style="margin-top: 15px; color: #000000 !important;">
                <strong style="color: #000000 !important;">Tendance :</strong>
                <span class="{% if trend_percentage > 0 %}trend-up{% else %}trend-down{% endif %}" style="{% if trend_percentage > 0 %}color: #28a745 !important;{% else %}color: #dc3545 !important;{% endif %}">
                    {% if trend_percentage > 0 %}
                        <i class="bi bi-arrow-up"></i> +{{ trend_percentage }}% (croissance)
                    {% else %}
                        <i class="bi bi-arrow-down"></i> {{ trend_percentage }}% (d√©croissance)
                    {% endif %}
                </span>
            </p>
            {% endif %}
        </div>
    </div>

    <!-- Graphique des revenus -->
    <div class="chart-container">
        <h3 style="color: #000000 !important;"><i class="bi bi-graph-up"></i> Tendances des revenus (Revenue Trends)</h3>
        <canvas id="revenueChart" 
                data-labels="{{ revenue_labels|safe }}" 
                data-data="{{ revenue_data|safe }}"
                style="max-height: 400px; height: 400px !important;"></canvas>
    </div>

    <!-- Graphique du volume de passagers -->
    <div class="chart-container">
        <h3 style="color: #000000 !important;"><i class="bi bi-people-fill"></i> Volume de passagers par jour</h3>
        <canvas id="passengerChart" 
                data-labels="{{ passenger_labels|safe }}" 
                data-data="{{ passenger_data|safe }}"
                style="max-height: 400px; height: 400px !important;"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Forcer le texte en noir pour les selects et afficher les ic√¥nes
    (function() {
        let initialized = false;
        
        function initSelects() {
            // √âviter les initialisations multiples
            if (initialized) return;
            
            const selects = document.querySelectorAll('.filters select');
            
            if (selects.length === 0) {
                return;
            }
            
            initialized = true;
            
            // Mapping des ic√¥nes pour chaque select
            const icons = {
                'period': {
                    '7': 'üìÖ',
                    '30': 'üìÖ',
                    '90': 'üìÖ',
                    '365': 'üìÖ',
                    'all': 'üìÖ'
                },
                'chart_type': {
                    'daily': 'üìä',
                    'weekly': 'üìä',
                    'monthly': 'üìä'
                }
            };
            
            function updateSelectIcon(select) {
                const selectedValue = select.value;
                const selectId = select.id;
                
                // R√©cup√©rer l'ic√¥ne correspondante
                let icon = '';
                if (selectId === 'period' && icons.period[selectedValue]) {
                    icon = icons.period[selectedValue];
                } else if (selectId === 'chart_type' && icons.chart_type[selectedValue]) {
                    icon = icons.chart_type[selectedValue];
                }
                
                // Mettre √† jour l'ic√¥ne affich√©e dans le span (√† gauche du select)
                const iconElement = document.getElementById(selectId + '-icon');
                if (iconElement) {
                    iconElement.textContent = icon || (selectId === 'period' ? 'üìÖ' : 'üìä');
                    iconElement.style.display = 'block';
                    iconElement.style.visibility = 'visible';
                    iconElement.style.opacity = '1';
                    iconElement.style.position = 'absolute';
                    iconElement.style.left = '15px';
                    iconElement.style.top = '50%';
                    iconElement.style.transform = 'translateY(-50%)';
                    iconElement.style.pointerEvents = 'none';
                    iconElement.style.fontSize = '1.3rem';
                    iconElement.style.zIndex = '1000';
                    iconElement.style.lineHeight = '1';
                    iconElement.style.color = '#000000';
                    console.log('Ic√¥ne mise √† jour:', selectId, icon, iconElement.textContent);
                } else {
                    console.error('√âl√©ment ic√¥ne non trouv√©:', selectId + '-icon');
                }
            }
            
            selects.forEach(function(select) {
                // Forcer le style au chargement
                select.style.backgroundColor = '#ffffff';
                select.style.color = '#000000';
                
                // S'assurer que le parent a position relative
                const parent = select.parentElement;
                if (parent) {
                    parent.style.position = 'relative';
                }
                
                // Afficher l'ic√¥ne au chargement
                updateSelectIcon(select);
                
                // Forcer le style et mettre √† jour l'ic√¥ne lors du changement
                select.addEventListener('change', function() {
                    this.style.backgroundColor = '#ffffff';
                    this.style.color = '#000000';
                    updateSelectIcon(this);
                });
                
                // Forcer le style lors du focus
                select.addEventListener('focus', function() {
                    this.style.backgroundColor = '#ffffff';
                    this.style.color = '#000000';
                });
                
                // Forcer le style pour les options
                const options = select.querySelectorAll('option');
                options.forEach(function(option) {
                    option.style.backgroundColor = '#ffffff';
                    option.style.color = '#000000';
                });
            });
        }
        
        // Fonction pour r√©initialiser (pour le chargement AJAX)
        function resetInit() {
            initialized = false;
        }
        
        // Initialiser au chargement du DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(initSelects, 100);
            });
        } else {
            setTimeout(initSelects, 100);
        }
        
        // R√©essayer une fois apr√®s un d√©lai pour le chargement AJAX
        setTimeout(function() {
            if (!initialized) {
                resetInit();
                initSelects();
            }
        }, 500);
    })();
    
    // Fonction globale pour initialiser les graphiques (accessible depuis la modal)
    window.initializeAnalyticsCharts = function() {
        console.log('D√©but de l\'initialisation des graphiques...');
        
        // V√©rifier que Chart.js est charg√©
        if (typeof Chart === 'undefined') {
            console.error('Chart.js n\'est pas charg√©');
            setTimeout(function() {
                if (typeof window.initializeAnalyticsCharts === 'function') {
                    window.initializeAnalyticsCharts();
                }
            }, 100);
            return;
        }
        
        // Chercher les canvas dans la modal d'abord, puis dans le document
        let revenueCanvas = document.querySelector('#aiModalBody #revenueChart');
        let passengerCanvas = document.querySelector('#aiModalBody #passengerChart');
        
        if (!revenueCanvas) {
            revenueCanvas = document.getElementById('revenueChart');
        }
        if (!passengerCanvas) {
            passengerCanvas = document.getElementById('passengerChart');
        }
        
        if (!revenueCanvas || !passengerCanvas) {
            console.log('Les canvas ne sont pas encore disponibles, nouvelle tentative...');
            console.log('revenueCanvas:', revenueCanvas, 'passengerCanvas:', passengerCanvas);
            setTimeout(function() {
                if (typeof window.initializeAnalyticsCharts === 'function') {
                    window.initializeAnalyticsCharts();
                }
            }, 200);
            return;
        }
        
        console.log('Canvas trouv√©s:', revenueCanvas, passengerCanvas);
        
        // D√©truire les graphiques existants s'ils existent
        if (window.revenueChartInstance) {
            window.revenueChartInstance.destroy();
        }
        if (window.passengerChartInstance) {
            window.passengerChartInstance.destroy();
        }
        
        try {
            // Charger les donn√©es depuis l'API
            let revenueLabels = [];
            let revenueData = [];
            let passengerLabels = [];
            let passengerData = [];
            
            // R√©cup√©rer les param√®tres de p√©riode et type de graphique depuis l'URL ou les selects
            const periodSelect = document.getElementById('period');
            const chartTypeSelect = document.getElementById('chart_type');
            const period = periodSelect ? periodSelect.value : '30';
            const chartType = chartTypeSelect ? chartTypeSelect.value : 'daily';
            
            // Charger les donn√©es depuis l'API
            fetch('/admin/analytics/data/?period=' + period + '&chart_type=' + chartType)
                .then(response => response.json())
                .then(data => {
                    revenueLabels = data.revenue_labels || [];
                    revenueData = data.revenue_data || [];
                    passengerLabels = data.passenger_labels || [];
                    passengerData = data.passenger_data || [];
                    
                    console.log('Donn√©es charg√©es depuis l\'API:', {
                        revenueLabels: revenueLabels.length,
                        revenueData: revenueData.length,
                        passengerLabels: passengerLabels.length,
                        passengerData: passengerData.length
                    });
                    
                    // Si pas de donn√©es depuis l'API, utiliser les valeurs du template
                    if (revenueLabels.length === 0 && revenueData.length === 0) {
                        try {
                            revenueLabels = JSON.parse({{ revenue_labels|safe }});
                            revenueData = JSON.parse({{ revenue_data|safe }});
                            passengerLabels = JSON.parse({{ passenger_labels|safe }});
                            passengerData = JSON.parse({{ passenger_data|safe }});
                            console.log('Donn√©es charg√©es depuis le template (fallback)');
                        } catch(e) {
                            console.error('Erreur lors du parsing des donn√©es par d√©faut:', e);
                        }
                    }
                    
                    // Cr√©er les graphiques avec les donn√©es
                    createCharts(revenueLabels, revenueData, passengerLabels, passengerData);
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des donn√©es:', error);
                    // Fallback : utiliser les donn√©es du template
                    try {
                        revenueLabels = JSON.parse({{ revenue_labels|safe }});
                        revenueData = JSON.parse({{ revenue_data|safe }});
                        passengerLabels = JSON.parse({{ passenger_labels|safe }});
                        passengerData = JSON.parse({{ passenger_data|safe }});
                        createCharts(revenueLabels, revenueData, passengerLabels, passengerData);
                    } catch(e) {
                        console.error('Erreur lors du parsing des donn√©es par d√©faut:', e);
                    }
                });
            
            // Fonction pour cr√©er les graphiques
            function createCharts(revenueLabels, revenueData, passengerLabels, passengerData) {
                // V√©rifier que nous avons des donn√©es
                if (revenueLabels.length === 0 || revenueData.length === 0) {
                    console.error('Aucune donn√©e disponible pour les graphiques de revenus');
                    return;
                }
                if (passengerLabels.length === 0 || passengerData.length === 0) {
                    console.error('Aucune donn√©e disponible pour les graphiques de passagers');
                    return;
                }

                // Graphique des revenus
                const revenueCtx = revenueCanvas.getContext('2d');
                window.revenueChartInstance = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: revenueLabels,
                    datasets: [{
                        label: 'Revenus (MAD)',
                        data: revenueData,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgb(102, 126, 234)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#000000',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgb(102, 126, 234)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#000000',
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#000000',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return value.toFixed(2) + ' MAD';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
                });

                // Graphique des passagers
                const passengerCtx = passengerCanvas.getContext('2d');
                window.passengerChartInstance = new Chart(passengerCtx, {
                type: 'bar',
                data: {
                    labels: passengerLabels,
                    datasets: [{
                        label: 'Nombre de passagers',
                        data: passengerData,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgb(102, 126, 234)',
                        borderWidth: 2,
                        borderRadius: 5,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#000000',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgb(102, 126, 234)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#000000',
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#000000',
                                font: {
                                    size: 12
                                },
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
                });
                
                console.log('Graphiques initialis√©s avec succ√®s');
            }
        } catch (error) {
            console.error('Erreur lors de l\'initialisation des graphiques:', error);
        }
    };
    
    // Alias pour compatibilit√©
    function initializeCharts() {
        if (typeof window.initializeAnalyticsCharts === 'function') {
            window.initializeAnalyticsCharts();
        }
    }
    
    // Initialiser les graphiques apr√®s le chargement
    // Cette fonction sera appel√©e automatiquement quand le contenu est charg√© dans la modal
    if (typeof Chart !== 'undefined') {
        // Chart.js est d√©j√† charg√©
        setTimeout(function() {
            if (typeof window.initializeAnalyticsCharts === 'function') {
                window.initializeAnalyticsCharts();
            }
        }, 200);
    } else {
        // Attendre que Chart.js soit charg√©
        const checkChart = setInterval(function() {
            if (typeof Chart !== 'undefined') {
                clearInterval(checkChart);
                setTimeout(function() {
                    if (typeof window.initializeAnalyticsCharts === 'function') {
                        window.initializeAnalyticsCharts();
                    }
                }, 200);
            }
        }, 100);
        
        // Timeout de s√©curit√© apr√®s 5 secondes
        setTimeout(function() {
            clearInterval(checkChart);
            if (typeof Chart !== 'undefined' && typeof window.initializeAnalyticsCharts === 'function') {
                window.initializeAnalyticsCharts();
            }
        }, 5000);
    }
</script>
{% endblock %}

